# =============================================================================
# Anki Sync Server Enhanced - Production with Docker Secrets
# =============================================================================
#
# Setup:
#   mkdir -p ./secrets
#   echo "username:password" > ./secrets/user1.txt
#   docker-compose -f docker-compose.secrets.yml up -d
#
# =============================================================================

services:
  anki-sync-server:
    image: chrislongros/anki-sync-server-enhanced:latest
    container_name: anki-sync-server
    
    ports:
      - "8080:8080"
      - "9090:9090"
    
    environment:
      - SYNC_USER1_FILE=/run/secrets/anki_user1
      - SYNC_USER2_FILE=/run/secrets/anki_user2
      - SYNC_HOST=0.0.0.0
      - SYNC_PORT=8080
      - SYNC_BASE=/data
      - LOG_LEVEL=info
      - TZ=Europe/Berlin
      - PUID=1000
      - PGID=1000
      - BACKUP_ENABLED=true
      - BACKUP_SCHEDULE=0 3 * * *
      - BACKUP_RETENTION_DAYS=14
      - METRICS_ENABLED=true
      - METRICS_PORT=9090
      - NOTIFY_ENABLED=true
      - NOTIFY_TYPE=discord
      - NOTIFY_WEBHOOK_URL_FILE=/run/secrets/discord_webhook
    
    secrets:
      - anki_user1
      - anki_user2
      - discord_webhook
    
    volumes:
      - anki_data:/data
      - anki_backups:/backups
    
    restart: unless-stopped

secrets:
  anki_user1:
    file: ./secrets/user1.txt
  anki_user2:
    file: ./secrets/user2.txt
  discord_webhook:
    file: ./secrets/discord.txt

volumes:
  anki_data:
    name: anki_sync_data
  anki_backups:
    name: anki_sync_backups
