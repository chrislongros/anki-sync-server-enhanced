# =============================================================================
# Anki Sync Server Enhanced - Production Configuration with Docker Secrets
# =============================================================================
#
# This configuration uses Docker secrets for secure credential management.
# Recommended for production deployments.
#
# Setup:
#   1. Create secrets directory: mkdir -p ./secrets
#   2. Create user files: echo "username:password" > ./secrets/user1.txt
#   3. Run: docker-compose -f docker-compose.secrets.yml up -d
#
# =============================================================================

services:
  anki-sync-server:
    image: chrislongros/anki-sync-server-enhanced:latest
    container_name: anki-sync-server
    
    ports:
      - "8080:8080"
      - "9090:9090"  # Metrics
    
    environment:
      # Use _FILE suffix to read credentials from Docker secrets
      - SYNC_USER1_FILE=/run/secrets/anki_user1
      - SYNC_USER2_FILE=/run/secrets/anki_user2
      
      # Server configuration
      - SYNC_HOST=0.0.0.0
      - SYNC_PORT=8080
      - SYNC_BASE=/data
      - LOG_LEVEL=info
      - TZ=Europe/Berlin
      
      # Enable all features
      - BACKUP_ENABLED=true
      - BACKUP_SCHEDULE=0 3 * * *
      - BACKUP_RETENTION_DAYS=14
      - METRICS_ENABLED=true
      - METRICS_PORT=9090
      
      # Notifications
      - NOTIFY_ENABLED=true
      - NOTIFY_TYPE=discord
      - NOTIFY_WEBHOOK_URL_FILE=/run/secrets/discord_webhook
    
    secrets:
      - anki_user1
      - anki_user2
      - discord_webhook
    
    volumes:
      - anki_data:/data
      - anki_backups:/backups
      - ./config:/config:ro
    
    restart: unless-stopped
    
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

# =============================================================================
# Secrets Definitions
# =============================================================================
secrets:
  anki_user1:
    file: ./secrets/user1.txt    # Contains: username:password
  anki_user2:
    file: ./secrets/user2.txt    # Contains: username:password
  discord_webhook:
    file: ./secrets/discord.txt  # Contains: webhook URL

# =============================================================================
# Volume Definitions
# =============================================================================
volumes:
  anki_data:
    name: anki_sync_data
  anki_backups:
    name: anki_sync_backups
